<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Processo Seletivo</title>
    <script src="libs/jquery.min.js"></script>
    <script src="libs/chartjs.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            height: 100%;
            position: relative;
        }

        body {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            color: #4d4d4d;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }

        header nav {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 40px;
        }

        header nav a {
            text-transform: uppercase;
            padding: 10px 15px;
            border-radius: 5px;
            border: 2px solid #4d4d4d;
            transition: 0.3s;
            text-decoration: none;
            color: #4d4d4d;
            font-weight: bold;
        }

        header nav a:hover {
            background: #4d4d4d;
            color: #FFF;
            transition: 0.3s;
        }

        article {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        canvas {
            margin-bottom: 40px;
        }

    </style>
</head>
<body>

<header>
    <nav>
        <a href="index.html">Área de Conhecimento</a>
        <a href="campi.html">Campi</a>
        <a href="curso.html">Curso</a>
        <a href="sexo.html">Sexo</a>
    </nav>
</header>

<article>

    <canvas id="inscritos"></canvas>
    <canvas id="inscritos_com_sexo"></canvas>
    <canvas id="maior_menor_nota_ac"></canvas>
    <canvas id="maior_menor_nota_cotas"></canvas>
    <canvas id="vagas_cotas_detalhada"></canvas>
    <canvas id="vagas_cotas"></canvas>

</article>

<script>

    let dados = [
        {
            url: 'resultados/area_conhecimento_inscritos_com_sexo_if.json',
            elemento: 'inscritos_com_sexo',
            titulo: 'TOTAL DE INSCRITOS POR SEXO',
            multidaset: true
        },
        {
            url: 'resultados/area_conhecimento_inscritos_if.json',
            elemento: 'inscritos',
            titulo: 'TOTAL DE INSCRITOS',
            multidaset: false
        },
        {
            url: 'resultados/area_conhecimento_maiores_menores_notas_corte_ampla_concorrencia_if.json',
            elemento: 'maior_menor_nota_ac',
            titulo: 'MAIOR E MENOR NOTA DE CORTE AC',
            multidaset: true
        },
        {
            // TODO corrigir o complemento do label no gráfico
            url: 'resultados/area_conhecimento_maiores_menores_notas_corte_cotas_if_editada.json',
            elemento: 'maior_menor_nota_cotas',
            titulo: 'MAIOR E MENOR NOTA DE CORTE POR COTAS',
            multidaset: true
        },
        {
            url: 'resultados/area_conhecimento_vagas_por_cotas_detalhada_if.json',
            elemento: 'vagas_cotas_detalhada',
            titulo: 'VAGAS POR COTAS DETALHADAS',
            multidaset: true
        },
        {
            url: 'resultados/area_conhecimento_vagas_por_cotas_if.json',
            elemento: 'vagas_cotas',
            titulo: 'VAGAS POR COTAS',
            multidaset: true
        }
    ];

    const loadDados = (dados) => {
        dados.forEach(v => {
            fetch(v.url)
                .then(function (res) {
                    res.json().then(function (result) {
                        grafico(result, v.elemento, v.titulo, v.multidaset)
                    })
                })
                .catch(function (err) {
                    console.log('Erro ao carregar os dados: ', err)
                });
        })
    };

    loadDados(dados);

    const grafico = function (dados, elemento, titulo, multidataset) {

        let elem = document.getElementById(elemento).getContext('2d'),
            config = {},
            colors = [
                '#001f3f', '#85144b', '#3D9970', '#FF4136', '#0074D9', '#FF851B',
                '#2ECC40', '#F012BE', '#39CCCC', '#7FDBFF', '#01FF70','#B10DC9', '#FFDC00'
            ],
            // colors = [
            //     '#001f3f', '#0074D9', '#7FDBFF', '#39CCCC', '#3D9970', '#2ECC40', '#01FF70', '#FFDC00',
            //     '#FF851B', '#FF4136', '#85144b', '#F012BE', '#B10DC9', '#111111', '#AAAAAA', '#DDDDDD'
            // ],
            labels = [],
            posicao_dados = [],
            novo = [],
            max_value = 0,
            min_value = 1000000;

        if (multidataset) {

            $.each(dados, function (i, v) {
                labels.push(i);
                if (v > max_value) max_value = v;
                if (v < min_value) min_value = v;

                posicao_dados.push(v);
            });

            config = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: []
                },
                options: {
                    animation: {
                        duration: 300,
                        easing: "easeOutQuart",
                        onComplete: function () {
                            let chartInstance = this.chart,
                                ctx = chartInstance.ctx;

                            ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontSize, Chart.defaults.global.defaultFontStyle, Chart.defaults.global.defaultFontFamily);
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';
                            ctx.fillStyle = '#4d4d4d';

                            this.data.datasets.forEach(function (dataset, i) {
                                let meta = chartInstance.controller.getDatasetMeta(i);
                                meta.data.forEach(function (bar, index) {
                                    let data = dataset.data[index];
                                    ctx.fillText(data, bar._model.x, bar._model.y + 0);
                                });
                            });
                        }
                    },
                    title: {
                        display: true,
                        text: titulo.toUpperCase(),
                        fontSize: 26,
                        fontColor: '#4d4d4d'
                    },
                    legend: {
                        labels: {
                            usePointStyle: true
                        }
                    },
                    hover: {
                        animationDuration: 0
                    },
                    tooltips: {
                        mode: 'point',
                        backgroundColor: '#9d9d9d',
                        borderColor: 'fff'
                    },
                    responsive: true
                }
            };

            $.each(Object.keys(posicao_dados[0]), function (i, v) {
                novo.push({indice: v, dados: []})
            });

            $.each(posicao_dados, function (i, v) {
                let cont = 0;

                $.each(v, function (a, b) {
                    if (typeof b === 'string' && b.split('|').length > 1) {
                        if (novo[cont].indice === a) {
                            novo[cont].dados.push(b.split('|')[0]);
                            novo[cont].complemento = b.split('|')[1];
                        }
                    } else {
                        if (novo[cont].indice === a) novo[cont].dados.push(b);
                    }

                    cont++;
                });
            });

            $.each(novo, function (i, v) {
                v.complemento = v.complemento !== undefined ? ' - ' + v.complemento : '';

                config.data.datasets.push({
                    label: (v.indice + v.complemento).toUpperCase(),
                    data: [],
                    backgroundColor: colors[i],
                    hoverBackgroundColor: colors[i],
                    borderColor: colors[i],
                    fill: false,
                    lineTension: 0,
                    pointHitRadius: 10,
                    pointStyle: 'rectRounded',
                    borderWidth: 3
                });

                $.each(v.dados, function (a, b) {
                    config.data.datasets[i].data.push(b);
                });
            });

        } else {

            $.each(dados, function (i, v) {
                if (i !== 'total') {
                    labels.push(i);
                    posicao_dados.push({indice: i, valor: v});
                    if (v > max_value) max_value = v;
                    if (v < min_value) min_value = v;
                }
            });

            config = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: titulo,
                        data: [],
                        backgroundColor: [],
                        borderColor: [],
                        pointStyle: 'rectRounded'
                    }]
                },
                options: {
                    animation: {
                        duration: 300,
                        easing: "easeOutQuart",
                        onComplete: function () {
                            let chartInstance = this.chart,
                                ctx = chartInstance.ctx;

                            ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontSize, Chart.defaults.global.defaultFontStyle, Chart.defaults.global.defaultFontFamily);
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';
                            ctx.fillStyle = '#4d4d4d';

                            this.data.datasets.forEach(function (dataset, i) {
                                let meta = chartInstance.controller.getDatasetMeta(i);
                                meta.data.forEach(function (bar, index) {
                                    let data = dataset.data[index];
                                    ctx.fillText(data, bar._model.x, bar._model.y + 0);
                                });
                            });
                        }
                    },
                    title: {
                        text: titulo,
                        fontSize: 26,
                        fontColor: '#4d4d4d',
                        display: true
                    },
                    legend: {
                        labels: {
                            usePointStyle: true
                        }
                    },
                    hover: {
                        animationDuration: 0
                    },
                    tooltips: {
                        // enabled: false,
                        mode: 'point',
                        backgroundColor: '#9d9d9d',
                        borderColor: 'fff'
                    },
                    scales: {
                        yAxes: [{
                            gridLines: {
                                drawBorder: false,
                                color: []
                            },
                            ticks: {
                                min: 0,
                                max: max_value,
                                stepSize: Math.ceil(max_value / 7)
                            }
                        }]
                    },
                    responsive: true
                }
            };

            $.each(posicao_dados, function (i, v) {
                if (v.indice !== 'total') {
                    config.data.datasets[0].backgroundColor.push(colors[i]);
                    config.data.datasets[0].borderColor.push(colors[i]);
                    config.data.datasets[0].data.push(v.valor);
                }
            });
        }

        return new Chart(elem, config);

    }

</script>
</body>
</html>